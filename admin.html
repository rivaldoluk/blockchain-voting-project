<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Pilkades 2025</title>

  <!-- Config & Ethers -->
  <script type="module">
    import config from '/public/config.js';
    window.CONFIG = config;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- CSS -->
  <link rel="stylesheet" href="admin.css">
</head>

<body class="dark-mode">
  <!-- SUARA NOTIFIKASI â€” TARUH DI ATAS SEMUA -->
  <audio id="voteSound" preload="auto" volume="0.8">
    <source src="https://www.myinstants.com/media/sounds/windows-notification.mp3" type="audio/mpeg">
  </audio>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loader">
      <i class="fas fa-circle-notch fa-spin"></i>
      <p id="loadingText">Memuat data...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Custom Modal -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Konfirmasi</h3>
        <span class="modal-close">x</span>
      </div>
      <div class="modal-body" id="modalMessage"></div>
      <div class="modal-footer">
        <button id="modalCancel" class="btn btn-secondary">Batal</button>
        <button id="modalConfirm" class="btn btn-primary">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Header + Theme Toggle + Connection Status -->
    <div class="header-bar">
      <div class="header">
        <h1>ADMIN PILKADES 2025</h1>
        <p>Kontrol Penuh & Transparan via Blockchain</p>
      </div>
      <div class="header-right">
        <div id="connectionStatus" class="connection-status">
          <span class="status-dot" data-status="offline"></span>
          <span class="status-text" id="statusText">
            <!-- JS yang akan isi otomatis -->
          </span>
        </div>
        <div class="update-info" id="updateTime">Update: --:--:--</div>
        <button id="themeToggle" class="theme-toggle" title="Ganti Mode">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <!-- Login Section -->
    <div id="login" class="section">
      <div id="status" class="status">Siap! klik Connect.</div>
      <button id="connectBtn" class="btn btn-connect full-width">
        <i class="fas fa-wallet"></i> Connect MetaMask (Ketua Panitia)
      </button>
      <div id="walletLockedWarning" class="warning-panel" style="display:none;">
        <i class="fas fa-lock"></i>
        <strong>MetaMask terkunci!</strong> Silakan buka MetaMask dan login terlebih dahulu.
      </div>
    </div>

    <!-- Main Panel (hidden sampai login) -->
    <div id="panel" class="section" style="display:none;">

      <!-- Sticky Quick Panel -->
      <div id="stickyPanel" class="sticky-panel">
        <div class="sticky-item"><strong>Status:</strong> <span id="stickyStatus">-</span></div>
        <div class="sticky-item"><strong>Timer:</strong> <span id="stickyTimer">00:00:00</span></div>
        <div class="sticky-item"><strong>Total Suara:</strong> <span id="stickyCounter">0</span></div>
        <button id="stickyRefresh" class="btn-refresh-small">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Admin Info -->
      <div class="info-grid">
        <div class="info-card">
          <p><strong>Admin:</strong> <span id="adminAddr">Loading...</span></p>
          <p><strong>Status Voting:</strong> <span id="votingStatus">Loading...</span></p>
          <p><strong>Total Pemilih:</strong> <span id="totalPemilih">0</span></p>
        </div>
        <div class="counter-card">
          <div id="liveCounter" class="live-counter">0</div>
          <div id="timer" class="timer">00:00:00</div>
          <div class="realtime-badge">Real-time aktif <i class="fas fa-circle pulse"></i></div>
        </div>
      </div>

      <!-- ========== BAGIAN BARU YANG SESUAI GAMBAR ========== -->

      <!-- Status Buka Voting -->
      <div style="margin: 32px 0; text-align: center;">
        <button id="bukaVotingBtn" class="btn btn-action full-width"
          style="font-size: 22px; padding: 20px; font-weight: 800;">
          BUKA VOTING (6 JAM)
        </button>
      </div>

      <!-- Pemenang Resmi / Sementara -->
      <div id="pemenangSection" style="display:none; margin: 32px 0;">
        <div id="winnerHeader" class="winner-header">Unggul Sementara</div>
        <div id="dynamicWinnersContainer"
          style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
          <!-- JS akan isi otomatis: 1 atau lebih kotak kandidat -->
        </div>
      </div>

      <!-- Grafik Real-time (Horizontal Bar) -->
      <div class="chart-section">
        <div class="section-title">Grafik Perolehan Suara Real-Time</div>
        <div class="chart-wrapper">
          <canvas id="voteChart"></canvas>
        </div>
      </div>

      <!-- Detail Perolehan Suara (Progress Bar + Persentase) -->
      <div class="detail-section">
        <div class="section-title">Perolehan Suara Real-Time</div>
        <div id="voteDetailGrid" class="vote-detail-grid">
          <!-- Will be filled by JS -->
        </div>
      </div>

      <!-- Pemilih Section (tetap sama) -->
      <div class="pemilih">
        <div class="pemilih-header">
          <h3>Daftar Pemilih (<span id="totalVotersCount">0</span>)</h3>
          <div class="header-actions">
            <select id="pageSizeSelect" class="page-size-select">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
            </select>
            <select id="kandidatFilter" class="kandidat-filter">
              <option value="">Semua Pemilih</option>
            </select>
            <button id="copyAllBtn" class="btn btn-copy-all"><i class="fas fa-copy"></i>Copy All</button>
            <button id="exportCSV" class="btn export-btn"><i class="fas fa-file-csv"></i>CSV</button>
            <button id="exportPDF" class="btn export-pdf"><i class="fas fa-file-pdf"></i>PDF</button>
          </div>
        </div>

        <input type="text" id="searchInput" class="search" placeholder="Cari address (0x...)" />

        <div class="voters-table-container">
          <table class="voters-table" id="votersTable">
            <thead>
              <tr>
                <th>No</th>
                <th>Address Pemilih</th>
                <th>Kandidat Dipilih</th>
                <th>Waktu Voting</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="votersTableBody"></tbody>
          </table>
        </div>

        <div class="pagination" id="pagination">
          <button id="prevBtn">Previous</button>
          <span id="pageInfo"></span>
          <button id="nextBtn">Next</button>
        </div>
      </div>

      <!-- Bottom Actions -->
      <div class="bottom-actions">
        <button id="scrollTopBtn" class="btn scroll-top-btn" style="display:none;">
          <i class="fas fa-arrow-up"></i> Ke Atas
        </button>
      </div>

      <!-- Log Aktivitas -->
      <details class="activity-log">
        <summary>Log Aktivitas Admin (Local)</summary>
        <div id="activityList"></div>
      </details>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module" src="admin.js"></script>
</body>

</html>